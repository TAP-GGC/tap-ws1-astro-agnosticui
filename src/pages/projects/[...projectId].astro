---
// Style Imports
import '../../styles/global.css';
import '@fontsource/source-sans-pro';
import '@fontsource/pixelify-sans';
import '@fontsource/ibm-plex-mono';
import '@fontsource/work-sans';
import '@fontsource/cormorant-garamond';
import '@fontsource/spectral';
import '@fontsource/crimson-pro';
import '@fontsource/alfa-slab-one';


// common.min.css is distributed with agnostic-react
// and agnostic-svelte too. But, since we're using all
// of these together, we only need to import global CSS
// once and in one place.
// common.min.css combines properties, resets, utilities
// import "agnostic-vue/dist/common.min.css";
// But!! Rob much prefers individual modular import ;)
import "agnostic-vue/dist/common.properties.min.css";
import "agnostic-vue/dist/common.resets.min.css";
import "agnostic-vue/dist/common.utilities.min.css";
import "agnostic-vue/dist/opinions.min.css";

// Component Imports
import "agnostic-vue/dist/index.css";
import { Image } from "astro:assets";

// Read from conten collection
import { getCollection, } from 'astro:content';

import Crumbs from "../../components/Crumbs.vue"

// 1. Generate a new path for every collection entry
// Goal 1: Make it redirect to the projects.astro page, using the parameters as values for 
export async function getStaticPaths() {
  const projects = await getCollection('projects');
  
  return projects.map(project => ({
    params: { "projectId": `${project.data.year}/${project.data.semester}/${project.data.id}` }, 
	props: { project },
  }));
  
}



// Goal 2: Actually  
// 2. For your template, you can get the entry directly from the prop
// const { slug } = Astro.params;
const { project} = Astro.props;
const { Content } = await project.render();

const allProjects = await getCollection('projects');

const relatedProjects = project.data.relatedIds?.length
  ? allProjects.filter(p => project.data.relatedIds.includes(p.data.id))
  : [];

// BreadCrumb variables
const  projYear  = project.data.year;
const  projSemester  = project.data.semester;
const  projName  = project.data.title;

// Page title
let title = `${projName} - Projects`;
import TAPDefaultLayout from "../../layouts/default.astro";
import { Debug } from 'astro:components';

// VideoAd
const visible = true; // Define visibility for videoAD
const showIframe = project.data.videoAd ? true : false; // Check if videoAd exists

// Returns the display name for a given ID.
// If the name exists in the corresponding collection (students or instructors), use it; otherwise, format the ID to a readable name.
function getNameFromID(id, type = 'student') {
	const collection = type === 'student' ? studentIds : facultyIds;
	const match = Object.values(collection).find(entry => entry?.data?.id === id);
	return match?.data?.name || formatIDtoName(id);
}

//Technologies card entries
const allTechs = await getCollection('technologies');
const techEntries = allTechs.filter(tech =>
  project.data.techs.includes(tech.data.id)
);

const techProjectCountMap = {};
for (const tech of techEntries) {
  const techId = tech.data.id;
  techProjectCountMap[techId] = allProjects.filter(p => p.data.techs?.includes(techId)).length;
}

//get student & instructor collections
// const studentData = project.data.students ? await getEntries(project.data.students) : [];
// const instructorData = project.data.instructors.slug ? await getEntries(project.data.instructors) : "Instructor-tbd";


// Github button
import { Button, ButtonGroup } from 'agnostic-vue';
import githubLogo from '/public/assets/github.svg';
import VideoAd from '../../components/astro/VideoAd.astro';
import Gallery from '../../components/astro/Gallery.astro';
import VideoCarousel from '../../components/vue/VideoCarousel.vue';
import Students from '../students.astro';
import studentIds from '../../components/astro/StudentIds';
import facultyIds from '../../components/astro/FacultyIds';
import { formatIDtoName } from '../../components/astro/formatNames';
import TechCard from '../../components/TechCard.vue';
import ProjectCard from '../../components/ProjectCard.vue';
import projectIds from '../../components/astro/ProjectIds';

// Logos
let imageLogoLight = project.data.imageLogoLight?.src;
let imageLogoDark = project.data.imageLogoDark ? project.data.imageLogoDark.src : imageLogoLight;
imageLogoLight = imageLogoLight ? imageLogoLight : imageLogoDark; // in case only dark is provided
const imageLogoTrans = project.data.imageLogoTrans?.src;
imageLogoLight = imageLogoTrans ? imageLogoTrans : imageLogoLight;
imageLogoDark = imageLogoTrans ? imageLogoTrans : imageLogoDark;
---

<TAPDefaultLayout title={title}>
	<Crumbs pageType="project" pageUrl=`/projects/${projYear}/${projSemester}/${project.data.id}`/>
	<div class="body-prj">
    <h1 class="projectTitle">{project.data.shortTitle ? project.data.shortTitle : project.data.title }</h1>
	{ project.data.shortTitle && (
		<h3 class="projectSubtitle"> {project.data.title} </h3>
	)}

	<img src= {imageLogoLight} alt="Project Image" class="TransparentLogo imageLight">
    <img src= {imageLogoDark} alt="Project Image" class="TransparentLogo imageDark">
	
	<div class="projectText">
		
		<!-- TODO: link to publications? or Github -->
		<h5><b> TEAM MEMBERS: </b>
			{project.data.students.map((student, index) => (
				<>
					<a href={`/students/${student}`}>{getNameFromID(student, 'student')}</a>
					{index < project.data.students.length - 1 ? ", " : ""}
				</>
			))}
		</h5>

		
		<h5><b> ADVISORS: </b>  
			{project.data.instructors.map((instructor, index) => (
				<>
				<a href={`/instructors/${instructor}`}>{getNameFromID(instructor, 'instructor')}</a>
				{index < project.data.instructors.length - 1 ? ", " : ""}
				</>
				))}
		
		</h5>
		
		<h5>
			<b>TECH:</b>
			{project.data.techs.map((tech, index) => (
			  <>
				<a href={`/techs/${tech}`}>{tech}</a>
				{index < project.data.techs.length - 1 ? ", " : ""}
			  </>
			))}
		  </h5>

		<h5><b> DIFFICULTY: </b> 
			{project.data.difficulty.map((diff, index) =>(
			<>
			<a href={`/difficulties/${diff}`}>{diff}</a>
			{index < project.data.difficulty.length - 1 ? ", " : ""}
			</>
			))} 
		</h5>
		
		<h5><b> TARGET AUDIENCE: </b>
			{project.data.levels.map((level, index) =>(
				<>
				<a href={`/levels/${level}`}>{level}</a>
				{index < project.data.levels.length - 1 ? ", " : ""}
				</>
			))} 
		</h5>
		
		<h5><b> DURATION: </b> {project.data.durationMins.join(" - ")} minutes</h5>

		<!-- <h5><b> CURATOR(S): </b> {project.data.curator?.join(", ")} </h5> -->
		<h5><b> CURATOR(S): </b>
			{project.data.curator?.map((student, index) => (
				<>
					<a href={`/students/${student}`}>{getNameFromID(student, 'student')}</a>
					{index < project.data.students.length - 1 ? ", " : ""}
				</>
			))}
		</h5>

		<h5><b> PUBLISHED DATE:</b> {project.data.publishedDate.toDateString().slice(4)} </h5>
		<!-- TODO: change format of date -->

		<h5><b> CREATED IN SEMESTER:</b> {project.data.semester[0].toUpperCase()}{project.data.semester.slice(1)} {project.data.year} </h5>

		<h5>Read more on
			<a href={project.data.github} target="_blank">
			<Button mode="primary" isRounded>Github <Image src={githubLogo} alt="GitHub Octocat" class="octocat-logo"></Image></button>
			</a>
		</h5>

	</div>

	{ project.data?.videoAd && ( /* Video Ad */
		<VideoAd src={project.data.videoAd} showIframe={true}></VideoAd>
			)}
	

    <Content />

	{techEntries.length > 0 && (
	<>
		<h3 class="mt-5" style="text-align: center;">Technologies Used</h3>
		<div class="tech-card-grid">
		{techEntries.map(tech => (
			<TechCard client:load tech={tech.data} projectCount={techProjectCountMap[tech.data.id] || 0}/>
		))}
		</div>
	</>
	)}

	<div class="prj-setup-section">
		{project.data?.videos?.[0] && (
			// <h2>Project Setup & Installation:2</h2>
			<VideoCarousel client:load videos={project.data.videos} showIframe={true}/>
			)

		}
	</div>

	{project.data?.images && (
		<h2 style="text-align: center;">Gallery</h2>
		<Gallery photos={project.data.images} />
	  )}

	{relatedProjects.length > 0 && (
	<>
		<h2 style="text-align: center; margin-top: 3rem;">Related Projects</h2>
		<div class="related-projects-container">
			{relatedProjects.map(project => (
				<ProjectCard item={projectIds[project.data.id]} />
			))}
		</div>
	</>
	)}

	<h2 style="text-align: center; margin-top: 3rem;">Comments</h2>
	<div id="discourse-comments"></div>
</div>

<script is:inline>
  var DiscourseEmbed = {
    discourseUrl: "https://forum.tapggc.org/",
    discourseEmbedUrl: window.location.href
  };

  (function() {
    var d = document.createElement("script"); d.type = "text/javascript"; d.async = true;
    d.src = DiscourseEmbed.discourseUrl + "javascripts/embed.js";
    (document.getElementsByTagName("head")[0] || 
     document.getElementsByTagName("body")[0]).appendChild(d);
  })();
</script>

<script is:inline>
(async () => {
  const DISCOURSE = 'https://forum.tapggc.org';     
  const PAGE_URL  = window.location.href.split('#')[0];

  const container = document.createElement('div');
  container.id = 'tap-poll';
  container.style.cssText = 'margin:1rem 0;font:600 16px/1.2 system-ui,sans-serif';
  container.textContent = 'Loading pollâ€¦';
  document.getElementById('discourse-comments').before(container);

  try {
    // Resolve the topic created by the embed for THIS page URL
    const r1 = await fetch(`${DISCOURSE}/embed.json?embed_url=${encodeURIComponent(PAGE_URL)}`,
      { headers: { 'Accept': 'application/json' } });
    if (!r1.ok) throw new Error(`embed.json HTTP ${r1.status}`);
    const embed = await r1.json();
    const topicId = embed?.topic_id;
    if (!topicId) { container.textContent = 'Poll not found.'; return; }

    //Fetch topic JSON to get the ordered list of post IDs
    const r2 = await fetch(`${DISCOURSE}/t/${topicId}.json`,
      { headers: { 'Accept': 'application/json' } });
    if (!r2.ok) throw new Error(`topic.json HTTP ${r2.status}`);
    const topic = await r2.json();

    // post_stream.stream is an array of post_ids in order:
    // [ first_post_id (post_number 1), first_reply_id (post_number 2), ... ]
    const stream = topic?.post_stream?.stream || [];
    const firstReplyId = stream[1]; // post_number === 2
    
    const targetPostId = firstReplyId ?? stream[0];

    if (!targetPostId) { container.textContent = 'Poll not found.'; return; }

    //Fetch the specific post JSON (contains polls[])
    const r3 = await fetch(`${DISCOURSE}/posts/${targetPostId}.json`,
      { headers: { 'Accept': 'application/json' } });
    if (!r3.ok) throw new Error(`posts.json HTTP ${r3.status}`);
    const post = await r3.json();

    const polls = post?.polls;
    if (!polls || !polls.length) {
      container.textContent = 'Poll not found.';
      return;
    }
	console.log(polls);
	
  } catch (err) {
    console.error('[poll]', err);
    container.textContent = 'Poll unavailable.';
  }
    
})();
</script>

<style>
	

	.octocat-logo{
	margin-left: 8px;
    width: 30px;
    height: 30px;
	}

	.projectImage {
		margin-right: 1em;
		width: clamp(25em, 50%, 45em);
		float: left;
		padding-bottom: 0.5em;
		padding-right: 0.5em;
	}

	.TransparentLogo{
		margin-right: 1em;
		width: clamp(15em, 50%, 25em);
		float: left;
		padding-bottom: 0.5em;
		padding-right: 0.5em;
	}

	.projectText {
		font-size: 1.25em; 
		text-align: left;
		/* width: clamp(15em, 45%, 45em); */
		vertical-align: bottom; 			
		display: inline;
		margin-bottom: 1em; /* doesn't work when display: inline */
	}

	.projectText h5 {
		margin-bottom: 0.5em;
	}

	h1.projectTitle {
		text-align: center;
	}

	h2.projectSubtitle {
		margin-top: 0em;
		margin-bottom: 1em; 
		/* margin: 0em auto 1em; */
		text-align: center;
	}

	.body-prj h2 {
		margin-top: 2em;
	}
	
	h5{
		margin: 1.5rem, auto;
		gap: 1rem;
	}

	.prj-setup-section{
    	justify-content: center;
		align-items: center;
    	height: fit-content;
		position: relative;
		margin: 0 auto;
  }

	.related-projects-container {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 1.5rem;
		margin-top: 1rem;
		padding: 0 1rem;
	}

	.tech-card-grid {
		display: grid;
		grid-auto-flow: row;
		grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
		gap: 1rem;
		margin-top: 1rem;
		justify-items: center;
	}
</style>
</TAPDefaultLayout>

