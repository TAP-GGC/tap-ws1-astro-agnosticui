---
// Style Imports
import '../../styles/global.css';
import '@fontsource/source-sans-pro';
import '@fontsource/pixelify-sans';
import '@fontsource/ibm-plex-mono';
import '@fontsource/work-sans';
import '@fontsource/cormorant-garamond';
import '@fontsource/spectral';
import '@fontsource/crimson-pro';
import '@fontsource/alfa-slab-one';


// common.min.css is distributed with agnostic-react
// and agnostic-svelte too. But, since we're using all
// of these together, we only need to import global CSS
// once and in one place.
// common.min.css combines properties, resets, utilities
// import "agnostic-vue/dist/common.min.css";
// But!! Rob much prefers individual modular import ;)
import "agnostic-vue/dist/common.properties.min.css";
import "agnostic-vue/dist/common.resets.min.css";
import "agnostic-vue/dist/common.utilities.min.css";
import "agnostic-vue/dist/opinions.min.css";

// Component Imports
import "agnostic-vue/dist/index.css";
import { Image } from "astro:assets";

// Read from conten collection
import { getCollection, } from 'astro:content';

import Crumbs from "../../components/Crumbs.vue"

// 1. Generate a new path for every collection entry
// Goal 1: Make it redirect to the projects.astro page, using the parameters as values for 
export async function getStaticPaths() {
  const projects = await getCollection('projects');
  
  return projects.map(project => ({
    params: { "projectId": `${project.data.year}/${project.data.semester}/${project.data.id}` }, 
	props: { project },
  }));
  
}



// Goal 2: Actually  
// 2. For your template, you can get the entry directly from the prop
// const { slug } = Astro.params;
const { project} = Astro.props;
const { Content } = await project.render();

const allProjects = await getCollection('projects');

const relatedProjects = project.data.relatedIds?.length
  ? allProjects.filter(p => project.data.relatedIds.includes(p.data.id))
  : [];

// BreadCrumb variables
const  projYear  = project.data.year;
const  projSemester  = project.data.semester;
const  projName  = project.data.title;

// Page title
let title = `${projName} - Projects`;
import TAPDefaultLayout from "../../layouts/default.astro";
import { Debug } from 'astro:components';

// VideoAd
const visible = true; // Define visibility for videoAD
const showIframe = project.data.videoAd ? true : false; // Check if videoAd exists

// Returns the display name for a given ID.
// If the name exists in the corresponding collection (students or instructors), use it; otherwise, format the ID to a readable name.
function getNameFromID(id, type = 'student') {
	const collection = type === 'student' ? studentIds : facultyIds;
	const match = Object.values(collection).find(entry => entry?.data?.id === id);
	return match?.data?.name || formatIDtoName(id);
}

//Technologies card entries
const allTechs = await getCollection('technologies');
const techEntries = allTechs.filter(tech =>
  project.data.techs.includes(tech.data.id)
);

const techProjectCountMap = {};
for (const tech of techEntries) {
  const techId = tech.data.id;
  techProjectCountMap[techId] = allProjects.filter(p => p.data.techs?.includes(techId)).length;
}

//get student & instructor collections
// const studentData = project.data.students ? await getEntries(project.data.students) : [];
// const instructorData = project.data.instructors.slug ? await getEntries(project.data.instructors) : "Instructor-tbd";


// Github button
import { Button, ButtonGroup } from 'agnostic-vue';
import githubLogo from '/public/assets/github.svg';
import VideoAd from '../../components/astro/VideoAd.astro';
import Gallery from '../../components/astro/Gallery.astro';
import VideoCarousel from '../../components/vue/VideoCarousel.vue';
import Students from '../students.astro';
import studentIds from '../../components/astro/StudentIds';
import facultyIds from '../../components/astro/FacultyIds';
import { formatIDtoName } from '../../components/astro/formatNames';
import TechCard from '../../components/TechCard.vue';
import ProjectCard from '../../components/ProjectCard.vue';
import projectIds from '../../components/astro/ProjectIds';

// Logos
let imageLogoLight = project.data.imageLogoLight?.src;
let imageLogoDark = project.data.imageLogoDark ? project.data.imageLogoDark.src : imageLogoLight;
imageLogoLight = imageLogoLight ? imageLogoLight : imageLogoDark; // in case only dark is provided
const imageLogoTrans = project.data.imageLogoTrans?.src;
imageLogoLight = imageLogoTrans ? imageLogoTrans : imageLogoLight;
imageLogoDark = imageLogoTrans ? imageLogoTrans : imageLogoDark;
---

<TAPDefaultLayout title={title}>
	<Crumbs pageType="project" pageUrl=`/projects/${projYear}/${projSemester}/${project.data.id}`/>
	<div class="body-prj">
    <h1 class="projectTitle">{project.data.shortTitle ? project.data.shortTitle : project.data.title }</h1>
	{ project.data.shortTitle && (
		<h3 class="projectSubtitle"> {project.data.title} </h3>
	)}

	<img src= {imageLogoLight} alt="Project Image" class="TransparentLogo imageLight">
    <img src= {imageLogoDark} alt="Project Image" class="TransparentLogo imageDark">
	
	<div class="projectText">
		
		<!-- TODO: link to publications? or Github -->
		<h5><b> TEAM MEMBERS: </b>
			{project.data.students.map((student, index) => (
				<>
					<a href={`/students/${student}`}>{getNameFromID(student, 'student')}</a>
					{index < project.data.students.length - 1 ? ", " : ""}
				</>
			))}
		</h5>

		
		<h5><b> ADVISORS: </b>  
			{project.data.instructors.map((instructor, index) => (
				<>
				<a href={`/instructors/${instructor}`}>{getNameFromID(instructor, 'instructor')}</a>
				{index < project.data.instructors.length - 1 ? ", " : ""}
				</>
				))}
		
		</h5>
		
		<h5>
			<b>TECH:</b>
			{project.data.techs.map((tech, index) => (
			  <>
				<a href={`/techs/${tech}`}>{tech}</a>
				{index < project.data.techs.length - 1 ? ", " : ""}
			  </>
			))}
		  </h5>

		<h5><b> DIFFICULTY: </b> 
			{project.data.difficulty.map((diff, index) =>(
			<>
			<a href={`/difficulties/${diff}`}>{diff}</a>
			{index < project.data.difficulty.length - 1 ? ", " : ""}
			</>
			))} 
		</h5>
		
		<h5><b> TARGET AUDIENCE: </b>
			{project.data.levels.map((level, index) =>(
				<>
				<a href={`/levels/${level}`}>{level}</a>
				{index < project.data.levels.length - 1 ? ", " : ""}
				</>
			))} 
		</h5>
		
		<h5><b> DURATION: </b> {project.data.durationMins.join(" - ")} minutes</h5>

		<!-- <h5><b> CURATOR(S): </b> {project.data.curator?.join(", ")} </h5> -->
		<h5><b> CURATOR(S): </b>
			{project.data.curator?.map((student, index) => (
				<>
					<a href={`/students/${student}`}>{getNameFromID(student, 'student')}</a>
					{index < project.data.students.length - 1 ? ", " : ""}
				</>
			))}
		</h5>

		<h5><b> PUBLISHED DATE:</b> {project.data.publishedDate.toDateString().slice(4)} </h5>
		<!-- TODO: change format of date -->

		<h5><b> CREATED IN SEMESTER:</b> {project.data.semester[0].toUpperCase()}{project.data.semester.slice(1)} {project.data.year} </h5>

		<h5>Read more on
			<a href={project.data.github} target="_blank">
			<Button mode="primary" isRounded>Github <Image src={githubLogo} alt="GitHub Octocat" class="octocat-logo"></Image></button>
			</a>
		</h5>

	</div>

	{ project.data?.videoAd && ( /* Video Ad */
		<VideoAd src={project.data.videoAd} showIframe={true}></VideoAd>
			)}
	

    <Content />

	{techEntries.length > 0 && (
	<>
		<h3 class="mt-5" style="text-align: center;">Technologies Used</h3>
		<div class="tech-card-grid">
		{techEntries.map(tech => (
			<TechCard client:load tech={tech.data} projectCount={techProjectCountMap[tech.data.id] || 0}/>
		))}
		</div>
	</>
	)}

	<div class="prj-setup-section">
		{project.data?.videos?.[0] && (
			// <h2>Project Setup & Installation:2</h2>
			<VideoCarousel client:load videos={project.data.videos} showIframe={true}/>
			)

		}
	</div>

	{project.data?.images && (
		<h2 style="text-align: center;">Gallery</h2>
		<Gallery photos={project.data.images} />
	  )}

	{relatedProjects.length > 0 && (
	<>
		<h2 style="text-align: center; margin-top: 3rem;">Related Projects</h2>
		<div class="related-projects-container">
			{relatedProjects.map(project => (
				<ProjectCard item={projectIds[project.data.id]} />
			))}
		</div>
	</>
	)}

	<h2 style="text-align: center; margin-top: 3rem;">Comments</h2>
	<div id="discourse-comments"></div>
</div>

<script is:inline>
  var DiscourseEmbed = {
    discourseUrl: "https://forum.tapggc.org/",
    discourseEmbedUrl: window.location.href
  };

  (function() {
    var d = document.createElement("script"); d.type = "text/javascript"; d.async = true;
    d.src = DiscourseEmbed.discourseUrl + "javascripts/embed.js";
    (document.getElementsByTagName("head")[0] || 
     document.getElementsByTagName("body")[0]).appendChild(d);
  })();
</script>

<script is:inline>
  // Wait for Discourse embed to load
  function fetchAndDisplayPolls() {
    // Get the iframe created by Discourse
    const iframe = document.querySelector('iframe[src*="forum.tapggc.org"]');
    if (!iframe) {
      console.log("[v0] Waiting for iframe...");
      setTimeout(fetchAndDisplayPolls, 500);
      return;
    }

    // Extract topic ID from the embed URL
    // Format: https://forum.tapggc.org/t/topic-slug/ID/1
    const src = iframe.src;
    const topicMatch = src.match(/\/t\/[^/]+\/(\d+)/);
    
    if (!topicMatch) {
      console.log("[v0] Could not extract topic ID from iframe");
      return;
    }

    const topicId = topicMatch[1];
    const postNumber = 2; // First comment

    console.log("[v0] Found topic ID:", topicId);

    // Fetch post data from Discourse API
    fetch(`https://forum.tapggc.org/posts/${postNumber}.json?topic_id=${topicId}`)
      .then(response => response.json())
      .then(data => {
        console.log("[v0] Poll data:", data.polls);
        if (data.polls) {
          displayPollResults(data.polls, iframe);
        }
      })
      .catch(error => console.error("[v0] Error fetching poll data:", error));
  }

  function displayPollResults(polls, iframe) {
    // Wait a bit for iframe to render, then find the poll link
    setTimeout(() => {
      try {
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const pollLink = iframeDoc.querySelector('a[href*="poll"]') || 
                        Array.from(iframeDoc.querySelectorAll('a'))
                          .find(a => a.textContent.includes("Click to view the poll"));

        if (!pollLink) {
          console.log("[v0] Poll link not found in iframe");
          return;
        }

        // Create poll results HTML
        const pollContainer = document.createElement('div');
        pollContainer.className = 'poll-results-container';
        pollContainer.style.cssText = 'margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;';

        Object.values(polls).forEach(poll => {
          const pollHTML = createPollHTML(poll);
          pollContainer.innerHTML += pollHTML;
        });

        // Insert after the embedded post
        const postContent = pollLink.closest('[class*="cooked"]');
        if (postContent) {
          postContent.parentElement.insertBefore(pollContainer, postContent.nextSibling);
          pollLink.style.display = 'none'; // Hide the original link
        }
      } catch (e) {
        console.log("[v0] Cannot access iframe content (cross-origin)");
      }
    }, 1000);
  }

  function createPollHTML(poll) {
    const totalVotes = poll.voters || poll.options.reduce((sum, opt) => sum + opt.votes, 0);
    const options = poll.options.map(option => {
      const votes = option.votes || 0;
      const percentage = totalVotes > 0 ? Math.round((votes / totalVotes) * 100) : 0;
      return `
        <div style="margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span style="font-weight: 500; font-size: 14px;">${option.html}</span>
            <span style="font-size: 13px; color: #666;">${percentage}%</span>
          </div>
          <div style="width: 100%; background: #e0e0e0; border-radius: 4px; height: 20px; overflow: hidden;">
            <div style="width: ${percentage}%; background: #0066cc; height: 100%; transition: width 0.3s;"></div>
          </div>
        </div>
      `;
    }).join('');

    return `
      <div style="margin-bottom: 15px;">
        <h4 style="margin: 0 0 10px 0; font-size: 16px; font-weight: 600;">${poll.name}</h4>
        ${options}
        <div style="margin-top: 10px; font-size: 12px; color: #999;">Total votes: ${totalVotes}</div>
      </div>
    `;
  }

  // Start fetching when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchAndDisplayPolls);
  } else {
    fetchAndDisplayPolls();
  }
</script>

<style>
	

	.octocat-logo{
	margin-left: 8px;
    width: 30px;
    height: 30px;
	}

	.projectImage {
		margin-right: 1em;
		width: clamp(25em, 50%, 45em);
		float: left;
		padding-bottom: 0.5em;
		padding-right: 0.5em;
	}

	.TransparentLogo{
		margin-right: 1em;
		width: clamp(15em, 50%, 25em);
		float: left;
		padding-bottom: 0.5em;
		padding-right: 0.5em;
	}

	.projectText {
		font-size: 1.25em; 
		text-align: left;
		/* width: clamp(15em, 45%, 45em); */
		vertical-align: bottom; 			
		display: inline;
		margin-bottom: 1em; /* doesn't work when display: inline */
	}

	.projectText h5 {
		margin-bottom: 0.5em;
	}

	h1.projectTitle {
		text-align: center;
	}

	h2.projectSubtitle {
		margin-top: 0em;
		margin-bottom: 1em; 
		/* margin: 0em auto 1em; */
		text-align: center;
	}

	.body-prj h2 {
		margin-top: 2em;
	}
	
	h5{
		margin: 1.5rem, auto;
		gap: 1rem;
	}

	.prj-setup-section{
    	justify-content: center;
		align-items: center;
    	height: fit-content;
		position: relative;
		margin: 0 auto;
  }

	.related-projects-container {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 1.5rem;
		margin-top: 1rem;
		padding: 0 1rem;
	}

	.tech-card-grid {
		display: grid;
		grid-auto-flow: row;
		grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
		gap: 1rem;
		margin-top: 1rem;
		justify-items: center;
	}
</style>
</TAPDefaultLayout>

